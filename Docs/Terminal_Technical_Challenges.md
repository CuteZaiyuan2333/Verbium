# Verbium Terminal 遗留技术挑战 (v0.2)

本文档记录了当前 Terminal 插件在 0.2 版本中尚未完全解决的深层技术问题，供后续更高级别的模型（如 Gemini 3 Pro）参考或进行深度重构。

## 1. 缓冲区重流与回滚 (Buffer Reflow & Scrollback)

### 现状
目前采用简单的 `Vec<Vec<Cell>>` 二维矩阵存储显示内容。当窗口宽度（Cols）发生变化时，仅对矩阵进行末尾截断或空间填充。

### 挑战
- **内容丢失**：当窗口缩窄时，原本位于行末的内容会被截断并永久丢失。
- **重流需求**：真正的终端在宽度缩窄时，应当将长行内容自动折行显示；在宽度增加时，应当将之前折行的内容拉回。
- **性能**：频繁的重流计算在高性能输出时可能导致 UI 线程阻塞。

### 建议方向
- 引入线性缓冲区结构，记录每一行的“软换行（Soft Wrap）”标志。
- 实现基于行号的逻辑坐标到基于视图的物理坐标的映射。

## 2. 深度 IME (输入法) 集成

### 现状
依赖 `egui` 默认的 `Event::Text` 事件获取合成后的最终文本。虽然支持中文输入，但缺乏交互反馈。

### 挑战
- **预输入显示**：用户在输入过程中（尚未按空格确定字符前），终端内无法显示输入法的拼音或下划线。
- **框位偏移**：输入法候选框的位置无法精准跟随终端内的字符光标位置（Cursor Row/Col），通常停留在窗口左上角或上一次点击的位置。

### 建议方向
- 使用 `egui` 的 IME 接口向 OS 反馈光标的 `Rect` 像素坐标。
- 监听 `Event::Ime` 事件，在终端网格中渲染待处理的预输入字符串。

## 3. 渲染性能优化 (Rendering Bottleneck)

### 现状
每帧渲染大约 80x40 = 3200 个字符。每个字符都通过 `painter.text()` 独立调用。

### 挑战
- **Draw Calls**：当终端处于 120Hz 刷新率且内容复杂时，数千次的文本渲染调用可能增加 GPU 提交压力。
- **布局开销**：`egui` 每次 `text()` 都会进行字体布局计算。

### 建议方向
- 实现字符阵列合并渲染，或者使用 `egui` 的 `Mesh` 接口直接操作顶点数据。
- 针对固定宽度字体（Monospace）实现自定义的位图缓存渲染。

## 4. 复杂 ANSI 序列与模式支持

### 现状
仅支持基础 16 色、光标定位及部分私有模式。

### 挑战
- **24-bit TrueColor**：尚未解析 `\x1b[38;2;R;G;Bm` 序列。
- **备用屏幕缓冲区 (Alt Buffer)**：运行 `vim` 或 `htop` 时需要切换到独立的缓冲区，并在退出后恢复原状。
- **鼠标支持**：尚未捕获并转发鼠标点击/滚动到 PTY。

---
**日期**: 2025年12月22日  
**模块**: `src/plugins/terminal/mod.rs`
