# Verbium Launcher 设计规范

Launcher 是 Verbium 生态系统的重要组成部分，负责管理静态插件的编译配置。

## 1. 核心职责

由于 Rust 不支持运行时反射加载源码，Verbium 采用 **Launcher 辅助构建** 的策略：
1.  **扫描**：遍历 `src/plugins/` 发现可用插件。
2.  **配置**：生成/修改 `src/plugins/generated.rs` 注册代码。
3.  **注入**：修改根目录 `Cargo.toml` 注入插件所需的外部依赖。
4.  **构建**：调用 `cargo build` 或 `cargo run` 启动编辑器。

## 2. 插件发现协议

Launcher 通过检测 `src/plugins/*/plugin.toml` 来识别插件。

### plugin.toml 格式
```toml
[plugin]
name = "my_plugin"       # 唯一标识符（对应 Rust 模块名）
display_name = "我的插件"
version = "0.1.0"
description = "插件描述"
dependencies = ["core"]  # 内部插件依赖顺序

[external_dependencies]
# 将会被注入到根 Cargo.toml 的 [dependencies] 中
serde = "1.0"
rand = { version = "0.8", features = ["small_rng"] }
```

## 3. 依赖注入逻辑

为了避免用户手动修改 `Cargo.toml` 导致冲突，Launcher 拥有 `Cargo.toml` 的部分管理权。

Launcher 会在 `Cargo.toml` 中寻找如下标记：
```toml
# --- BEGIN PLUGIN DEPENDENCIES ---
# ... Launcher 自动生成的内容 ...
# --- END PLUGIN DEPENDENCIES ---
```
以及：
```toml
[features]
default = ["plugin_core", "plugin_my_plugin"] # Launcher 自动更新
# ...
# --- END PLUGIN FEATURES ---
```

**关键规则**：
1.  Launcher **只**修改标记区间内的内容。
2.  所有注入的依赖项必须转换为 **Inline Table** 格式（例如 `crate = { version = "..." }`），以防止 TOML 解析错误。

## 4. 代码生成逻辑

Launcher 需要生成 `src/plugins/generated.rs`，以便主程序能通过 `mod` 语句找到插件。

生成的代码示例：
```rust
// Auto-generated by Verbium Launcher
#[cfg(feature = "plugin_code_editor")]
pub mod code_editor;

#[cfg(feature = "plugin_file_manager")]
pub mod file_manager;

pub fn get_extra_plugins() -> Vec<Box<dyn crate::Plugin>> {
    let mut plugins: Vec<Box<dyn crate::Plugin>> = Vec::new();

    #[cfg(feature = "plugin_code_editor")]
    plugins.push(Box::new(code_editor::create()));

    #[cfg(feature = "plugin_file_manager")]
    plugins.push(Box::new(file_manager::create()));

    plugins
}
```

## 5. UI 交互流

1.  **启动**：Launcher 读取当前配置。
2.  **列表**：左侧显示所有扫描到的插件，复选框表示是否启用（即是否加入 `default` features）。
3.  **同步**：用户点击 "Sync & Run" 后：
    - 更新 `Cargo.toml`。
    - 更新 `generated.rs`。
    - 执行 `cargo run`，并将 stdout/stderr 输出流重定向到 Launcher 的日志控制台。
